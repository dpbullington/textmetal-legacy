<?xml version="1.0" encoding="utf-8"?>

<!--
	Copyright ©2002-2014 Daniel Bullington (dpbullington@gmail.com)
	Distributed under the MIT license: http://www.opensource.org/licenses/mit-license.php
-->
<Template xmlns="http://www.textmetal.com/api/v5.0.0">

	<InvokeSourceStrategy src="${ObfuscationConfigFilePath}" alloc="true" var="obfuCfg" aqt-name="TextMetal.Framework.SourceModel.Primative.JsonSourceStrategy, TextMetal.Framework.SourceModel" />

	<OutputScope name="${ObfuscationConfigFilePath}.g" append="false">
<![CDATA[
{
  "TablesViews": [
]]>
	</OutputScope>

	<OutputScope name="Obfucation.g.sql">

<![CDATA[

SET NOCOUNT ON
GO


USE [master]
GO


IF EXISTS (SELECT * FROM sysdatabases WHERE name = '${DataObfuscationProxyCatalogName}')
BEGIN

	ALTER DATABASE [${DataObfuscationProxyCatalogName}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE
	
	DROP DATABASE [${DataObfuscationProxyCatalogName}]
	
END
GO


CREATE DATABASE [${DataObfuscationProxyCatalogName}]
GO


USE [${DataObfuscationProxyCatalogName}]
GO


CREATE SCHEMA [DataObfuscation]
GO


-- template for custom dictionary
CREATE TABLE [DataObfuscation].[CrayonColorDictionary]
(
	[CrayonColorDictionaryKey] [int] IDENTITY(0,1) NOT NULL,
	[CrayonColorDictionaryValue] [nvarchar](255) NOT NULL,
	
	CONSTRAINT [pk_CrayonColorDictionary] PRIMARY KEY
	(
		[CrayonColorDictionaryKey]
	),
	
	-- optional
	CONSTRAINT [uk_CrayonColorDictionary] UNIQUE
	(
		[CrayonColorDictionaryValue]
	)
)	
GO


INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Transparent')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Almond')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Antique Brass')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Apricot')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Aquamarine')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Asparagus')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Atomic Tangerine')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Banana Mania')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Beaver')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Bittersweet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Black')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blue Bell')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blue Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blue Violet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blush')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Brick Red')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Brown')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Burnt Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Burnt Sienna')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cadet Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Canary')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Caribbean Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Carnation Pink')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cerise')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cerulean')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Chestnut')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Copper')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cornflower')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cotton Candy')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Dandelion')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Denim')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Desert Sand')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Eggplant')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Electric Lime')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Fern')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Forest Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Fuchsia')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Fuzzy Wuzzy Brown')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Gold')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Goldenrod')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Granny Smith Apple')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Gray')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Green Yellow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Hot Magenta')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Inch Worm')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Indigo')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Jazzberry Jam')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Jungle Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Laser Lemon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Lavender')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Macaroni and Cheese')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Magenta')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Mahogany')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Manatee')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Mango Tango')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Maroon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Mauvelous')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Melon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Midnight Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Mountain Meadow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Navy Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Neon Carrot')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Olive Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Orchid')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Outer Space')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Outrageous Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Pacific Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Peach')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Periwinkle')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Piggy Pink')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Pine Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Pink Flamingo')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Pink Sherbet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Plum')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Purple Heart')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Purple Mountains’ Majesty')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Purple Pizzazz')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Radical Red')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Raw Sienna')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Razzle Dazzle Rose')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Razzmatazz')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Red')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Red Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Red Violet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Robin Egg Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Royal Purple')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Salmon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Scarlet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Screamin Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sea Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sepia')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Shadow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Shamrock')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Shocking Pink')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Silver')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sky Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Spring Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sunglow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sunset Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Tan')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Tickle Me Pink')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Timberwolf')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Tropical Rain Forest')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Tumbleweed')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Turquoise Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Unmellow Yellow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Violet (Purple)')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Violet Red')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Vivid Tangerine')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Vivid Violet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('White')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Wild Blue Yonder')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Wild Strawberry')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Wild Watermelon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Wisteria')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Yellow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Yellow Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Yellow Orange')
GO


CREATE ASSEMBLY [TextMetal.Common.SqlServerClr]
AUTHORIZATION [dbo]
FROM
]]>
		<Include name="${argument_basedir}\TextMetal.Common.SqlServerClr.dll.txt" />
<![CDATA[WITH PERMISSION_SET = SAFE
GO


CREATE FUNCTION [DataObfuscation].[fn_GetCipher]
(
	@sharedSecret [nvarchar](MAX),
	@value [sql_variant]
)
RETURNS [sql_variant]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetCipher]
GO


CREATE FUNCTION [DataObfuscation].[fn_GetHash]
(
	@hashMultiplier [bigint],
	@hashBucketSize [bigint],
	@hashSeed [bigint],
	@value [nvarchar](MAX)
)
RETURNS [int]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetHash]
GO


CREATE FUNCTION [DataObfuscation].[fn_GetMask]
(
	@maskFactor as [float],
	@value [sql_variant]
)
RETURNS [sql_variant]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetMask]
GO


CREATE FUNCTION [DataObfuscation].[fn_GetShuffle]
(
	@randomSeed [bigint],
	@value [sql_variant]
)
RETURNS [sql_variant]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetShuffle]
GO


CREATE FUNCTION [DataObfuscation].[fn_GetVariance]
(
	@varianceFactor as [float],
	@value [sql_variant]
)
RETURNS [sql_variant]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetVariance]
GO
]]>

	<ForEach in="Schemas" var-ct="_LoopCount" var-ix="_LoopIndex">
		<ForEach.Filter>
			<Ruby src="Script">
				<Script>!["db_accessadmin", "db_backupoperator", "db_datareader",
				"db_datawriter", "db_ddladmin", "db_denydatareader", "db_denydatawriter",
				"db_owner", "db_securityadmin", "sys",
				"INFORMATION_SCHEMA", "guest"].include?(textMetal.EvaluateToken.invoke("SchemaName"));</Script>
			</Ruby>	
		</ForEach.Filter>
		
		<ForEach.Body>
			<If>
				<If.Condition>
					<BinaryExpression operator="Ne">
						<BinaryExpression.LeftExpression>
							<Facet name="SchemaName" />
						</BinaryExpression.LeftExpression>
						<BinaryExpression.RightExpression>
							<Value type="System.String" data="dbo" />
						</BinaryExpression.RightExpression>
					</BinaryExpression>
				</If.Condition>
				<If.True>
<![CDATA[

CREATE SCHEMA [${SchemaName}]
GO
]]>
				</If.True>
				<If.False>
<![CDATA[

-- DO NOT CREATE SCHEMA [${SchemaName}]
]]>
				</If.False>
			</If>	

			<ForEach in="Tables" var-ct="_LoopCount" var-ix="_LoopIndex">
				<ForEach.Filter>
				</ForEach.Filter>
				<ForEach.Body>
<![CDATA[

CREATE VIEW [${SchemaName}].[${TableName}]
AS
	${rb(`
	#textMetal.DebuggerBreakpoint.invoke()
	x = textMetal.EvaluateToken.invoke("obfuCfg")
	y = x["TablesViews".to_clr_string()]
	`)}
	SELECT
]]>
				<ForEach in="Columns" var-ct="_LoopCount" var-ix="_LoopIndex">
					<ForEach.Sort>
						<Ascending>
							<Ascending.Compare>
								<Facet name="ColumnOrdinal" />
							</Ascending.Compare>
						</Ascending>
					</ForEach.Sort>
					<ForEach.Body>
					
<![CDATA[	CAST( t.[${ColumnName}] AS ${rb(`
	"[" + textMetal.EvaluateToken.invoke("ColumnSqlType") + "]" +	
	if ["varchar", "nvarchar", "varbinary"].include?(textMetal.EvaluateToken.invoke("ColumnSqlType"))
		"(" + (textMetal.EvaluateToken.invoke("ColumnSize") > 0 ? textMetal.EvaluateToken.invoke("ColumnSize").to_s() : "MAX") + ")"
	else
		""
	end + " ) as [" + textMetal.EvaluateToken.invoke("ColumnName") + "]"
`)}]]>

						

						<If>
							<If.Condition>
								<BinaryExpression operator="Ne">
									<BinaryExpression.LeftExpression>
										<Facet name="_LoopCount" />
									</BinaryExpression.LeftExpression>
									<BinaryExpression.RightExpression>
										<Facet name="_LoopIndex" />
									</BinaryExpression.RightExpression>
								</BinaryExpression>
							</If.Condition>
							<If.True>
<![CDATA[,
]]>
							</If.True>
						</If>
						
						
						<OutputScope name="${ObfuscationConfigFilePath}.g" append="true">
<![CDATA[
	{
      "CatalogName": "${InitialCatalogName}",
      "SchemaName": "${SchemaName}",
      "TableName": "${TableName}",
	  "ColumnName": "${ColumnName}",
	  "StrategyId": 0,
	  "DictionaryId": 0,
	  "HashSeed": 0,
	  "HashSize": 0
    },
]]>
						</OutputScope>
					</ForEach.Body>
				</ForEach>
<![CDATA[
	FROM [${DataObfuscationTargetServerName}].[${InitialCatalogName}].[${SchemaName}].[${TableName}] t

GO
]]>

				</ForEach.Body>
			</ForEach>

		</ForEach.Body>
	</ForEach>
		
	</OutputScope>
	
	<OutputScope name="${ObfuscationConfigFilePath}.g" append="true">
<![CDATA[	]
}
]]>
	</OutputScope>
	
</Template>