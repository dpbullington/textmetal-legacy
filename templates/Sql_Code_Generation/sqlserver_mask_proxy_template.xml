<?xml version="1.0" encoding="utf-8"?>

<!--
	Copyright ©2002-2014 Daniel Bullington (dpbullington@gmail.com)
	Distributed under the MIT license: http://www.opensource.org/licenses/mit-license.php
-->
<Template xmlns="http://www.textmetal.com/api/v5.0.0">

	<OutputScope name="ObfucationLayer.g.sql">

<![CDATA[

SET NOCOUNT ON
GO

USE [master]
GO


IF EXISTS (SELECT * FROM sysdatabases WHERE name = '${DataObfuscationProxyCatalogName}')
BEGIN

	ALTER DATABASE [${DataObfuscationProxyCatalogName}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE
	
	DROP DATABASE [${DataObfuscationProxyCatalogName}]
	
END
GO


CREATE DATABASE [${DataObfuscationProxyCatalogName}]
GO


USE [${DataObfuscationProxyCatalogName}]
GO


CREATE SCHEMA [DataObfuscation]
GO


-- template for custom dictionary
CREATE TABLE [DataObfuscation].[CrayonColorDictionary]
(
	[CrayonColorDictionaryKey] [int] IDENTITY(1,1) NOT NULL,
	[CrayonColorDictionaryValue] [nvarchar](255) NOT NULL,
	
	CONSTRAINT [pk_CrayonColorDictionary] PRIMARY KEY
	(
		[CrayonColorDictionaryKey]
	),
	
	-- optional
	CONSTRAINT [uk_CrayonColorDictionary] UNIQUE
	(
		[CrayonColorDictionaryValue]
	)
)	
GO


INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Almond')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Antique Brass')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Apricot')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Aquamarine')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Asparagus')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Atomic Tangerine')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Banana Mania')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Beaver')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Bittersweet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Black')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blue Bell')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blue Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blue Violet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Blush')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Brick Red')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Brown')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Burnt Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Burnt Sienna')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cadet Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Canary')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Caribbean Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Carnation Pink')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cerise')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cerulean')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Chestnut')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Copper')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cornflower')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Cotton Candy')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Dandelion')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Denim')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Desert Sand')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Eggplant')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Electric Lime')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Fern')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Forest Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Fuchsia')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Fuzzy Wuzzy Brown')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Gold')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Goldenrod')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Granny Smith Apple')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Gray')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Green Yellow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Hot Magenta')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Inch Worm')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Indigo')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Jazzberry Jam')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Jungle Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Laser Lemon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Lavender')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Macaroni and Cheese')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Magenta')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Mahogany')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Manatee')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Mango Tango')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Maroon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Mauvelous')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Melon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Midnight Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Mountain Meadow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Navy Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Neon Carrot')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Olive Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Orchid')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Outer Space')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Outrageous Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Pacific Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Peach')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Periwinkle')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Piggy Pink')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Pine Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Pink Flamingo')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Pink Sherbet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Plum')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Purple Heart')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Purple Mountains’ Majesty')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Purple Pizzazz')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Radical Red')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Raw Sienna')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Razzle Dazzle Rose')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Razzmatazz')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Red')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Red Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Red Violet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Robin Egg Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Royal Purple')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Salmon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Scarlet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Screamin Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sea Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sepia')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Shadow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Shamrock')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Shocking Pink')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Silver')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sky Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Spring Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sunglow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Sunset Orange')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Tan')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Tickle Me Pink')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Timberwolf')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Tropical Rain Forest')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Tumbleweed')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Turquoise Blue')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Unmellow Yellow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Violet (Purple)')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Violet Red')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Vivid Tangerine')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Vivid Violet')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('White')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Wild Blue Yonder')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Wild Strawberry')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Wild Watermelon')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Wisteria')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Yellow')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Yellow Green')
INSERT INTO [DataObfuscation].[CrayonColorDictionary] VALUES ('Yellow Orange')
GO


CREATE VIEW [DataObfuscation].[MasterDictionary]
AS
SELECT -1000 as [DictionaryConfigId], t.[CrayonColorDictionaryKey] as [Key], t.[CrayonColorDictionaryValue] as [Value]
	FROM [DataObfuscation].[CrayonColorDictionary] t
--	UNION ALL
-- more dictionaries
GO


CREATE TABLE [DataObfuscation].[DictionaryConfig]
(
	[DictionaryConfigId] [int] NOT NULL,
	[DictionaryConfigName] [nvarchar](64) NOT NULL,
	[IsWellKnown] [bit] NOT NULL,
	
	[HashMultiplier] [bigint] NOT NULL,
	[HashBucketSize] [bigint] NOT NULL,
	[HashSeed] [bigint] NOT NULL,
	
	CONSTRAINT [pk_DictionaryConfig] PRIMARY KEY
	(
		[DictionaryConfigId]
	),
	
	CONSTRAINT [uk_DictionaryConfig] UNIQUE
	(
		[DictionaryConfigName]
	)
)	
GO


INSERT INTO [DataObfuscation].[DictionaryConfig] VALUES (0, 'TextMetal Numeric Sign Dictionary', 1, 33, 1000000, 5381)
INSERT INTO [DataObfuscation].[DictionaryConfig] VALUES (-1000, 'TextMetal Crayon Color Dictionary', 0, 33, 120, 5381)
INSERT INTO [DataObfuscation].[DictionaryConfig] VALUES (-1100, 'TextMetal Variance Numeric Dictionary', 0, 33, 10, 5381)
INSERT INTO [DataObfuscation].[DictionaryConfig] VALUES (-1200, 'TextMetal Variance Date Dictionary', 0, 33, 120, 5381)
GO


CREATE TABLE [DataObfuscation].[Strategy]
(
	[StrategyId] [int] NOT NULL,
	[StrategyName] [nvarchar](64) NOT NULL,
	[StrategyDesc] [nvarchar](1023) NOT NULL,

	CONSTRAINT [pk_Strategy] PRIMARY KEY
	(
		[StrategyId]
	),
	
	CONSTRAINT [uk_Strategy] UNIQUE
	(
		[StrategyName]
	)
)	
GO


INSERT INTO [DataObfuscation].[Strategy] VALUES (0, 'None', 'Performs no obfuscation.');
INSERT INTO [DataObfuscation].[Strategy] VALUES (1, 'Substitution', 'Returns an alternate value for the real data using a hash appoach.');
INSERT INTO [DataObfuscation].[Strategy] VALUES (2, 'Shuffling', 'Returns an alternate value for the real data using a shuffle appoach.');
INSERT INTO [DataObfuscation].[Strategy] VALUES (3, 'Variance', 'Returns a value within +/- (x% | xd) of the real data.');
INSERT INTO [DataObfuscation].[Strategy] VALUES (4, 'Cipher', 'Returns an encrypted value for all real data.');
INSERT INTO [DataObfuscation].[Strategy] VALUES (5, 'Nulling', 'Return a null value instead of the real data.');
INSERT INTO [DataObfuscation].[Strategy] VALUES (6, 'Masking', 'Returns a mask value for most but not all of the real data.');
GO


CREATE TABLE [DataObfuscation].[StoredProcedureParameterConfig]
(
	[StoredProcedureParameterConfigId] [int] IDENTITY(1,1) NOT NULL,

	[CatalogName] [nvarchar](64) NOT NULL, -- skimping here to prevent index warning exceed 900 bytes
	[SchemaName] [nvarchar](128) NOT NULL,
	[ProcedureName] [nvarchar](128) NOT NULL,
	[ParameterName] [nvarchar](128) NOT NULL, -- output paramters only
	
	[StrategyId] [int] NOT NULL,
	
	[DictionaryConfigId] [int] NULL,

	CONSTRAINT [pk_StoredProcedureParameterConfig] PRIMARY KEY
	(
		[StoredProcedureParameterConfigId]
	),
	
	CONSTRAINT [uk_StoredProcedureParameterConfig] UNIQUE
	(
		[CatalogName],
		[SchemaName],
		[ProcedureName],
		[ParameterName]
	),
	
	CONSTRAINT [fk_StoredProcedureParameterConfig_Strategy] FOREIGN KEY
	(
		[StrategyId]
	)
	REFERENCES [DataObfuscation].[Strategy]
	(
		[StrategyId]
	),
	
	CONSTRAINT [fk_StoredProcedureParameterConfig_DictionaryConfig] FOREIGN KEY
	(
		[DictionaryConfigId]
	)
	REFERENCES [DataObfuscation].[DictionaryConfig]
	(
		[DictionaryConfigId]
	)
)	
GO


CREATE TABLE [DataObfuscation].[StoredProcedureColumnConfig]
(
	[StoredProcedureColumnConfigId] [int] IDENTITY(1,1) NOT NULL,

	[CatalogName] [nvarchar](64) NOT NULL, -- skimping here to prevent index warning exceed 900 bytes
	[SchemaName] [nvarchar](128) NOT NULL,
	[ProcedureName] [nvarchar](128) NOT NULL,
	[ColumnName] [nvarchar](128) NOT NULL, -- output resultset columns only
	
	[StrategyId] [int] NOT NULL,
	
	[DictionaryConfigId] [int] NULL,

	CONSTRAINT [pk_StoredProcedureColumnConfig] PRIMARY KEY
	(
		[StoredProcedureColumnConfigId]
	),
	
	CONSTRAINT [uk_StoredProcedureColumnConfig] UNIQUE
	(
		[CatalogName],
		[SchemaName],
		[ProcedureName],
		[ColumnName]
	),
	
	CONSTRAINT [fk_StoredProcedureColumnConfig_Strategy] FOREIGN KEY
	(
		[StrategyId]
	)
	REFERENCES [DataObfuscation].[Strategy]
	(
		[StrategyId]
	),
	
	CONSTRAINT [fk_StoredProcedureColumnConfig_DictionaryConfig] FOREIGN KEY
	(
		[DictionaryConfigId]
	)
	REFERENCES [DataObfuscation].[DictionaryConfig]
	(
		[DictionaryConfigId]
	)
)	
GO


CREATE TABLE [DataObfuscation].[TableViewColumnConfig]
(
	[TableViewColumnConfigId] [int] IDENTITY(1,1) NOT NULL,

	[CatalogName] [nvarchar](64) NOT NULL, -- skimping here to prevent index warning exceed 900 bytes
	[SchemaName] [nvarchar](128) NOT NULL,
	[TableName] [nvarchar](128) NOT NULL,
	[ColumnName] [nvarchar](128) NOT NULL,
	
	[StrategyId] [int] NOT NULL,
	
	[DictionaryConfigId] [int] NULL,

	CONSTRAINT [pk_TableViewColumnConfig] PRIMARY KEY
	(
		[TableViewColumnConfigId]
	),
	
	CONSTRAINT [uk_TableViewColumnConfig] UNIQUE
	(
		[CatalogName],
		[SchemaName],
		[TableName],
		[ColumnName]
	),
	
	CONSTRAINT [fk_TableViewColumnConfig_Strategy] FOREIGN KEY
	(
		[StrategyId]
	)
	REFERENCES [DataObfuscation].[Strategy]
	(
		[StrategyId]
	),
	
	CONSTRAINT [fk_TableViewColumnConfig_DictionaryConfig] FOREIGN KEY
	(
		[DictionaryConfigId]
	)
	REFERENCES [DataObfuscation].[DictionaryConfig]
	(
		[DictionaryConfigId]
	)
)	
GO


CREATE ASSEMBLY [TextMetal.Common.SqlServerClr]
AUTHORIZATION [dbo]
FROM 'D:\development\textmetal\src\TextMetal.Common.SqlServerClr\bin\Debug\TextMetal.Common.SqlServerClr.dll'
WITH PERMISSION_SET = SAFE
GO


CREATE FUNCTION [DataObfuscation].[fn_GetNull]
(
	@blank as [bit],
	@value [nvarchar](MAX)
)
RETURNS [nvarchar](MAX)
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetNull]
GO


CREATE FUNCTION [DataObfuscation].[fn_GetHash]
(
	@hashMultiplier [bigint],
	@hashBucketSize [bigint],
	@hashSeed [bigint],
	@value [sql_variant]
)
RETURNS [int]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetHash]
GO


CREATE FUNCTION [DataObfuscation].[fn_GetVariance]
(
	@varianceFactor as [float],
	@value [sql_variant]
)
RETURNS [sql_variant]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetVariance]
GO


CREATE FUNCTION [DataObfuscation].[fn_GetMask]
(
	@maskFactor as [float],
	@value [nvarchar](MAX)
)
RETURNS [nvarchar](MAX)
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetMask]
GO


CREATE FUNCTION [DataObfuscation].[fn_GetShuffle]
(
	@hashSeed [bigint],
	@value [nvarchar](MAX)
)
RETURNS [nvarchar](MAX)
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetShuffle]
GO


CREATE FUNCTION [DataObfuscation].[fn_ExecuteHashSubstitution]
(
	@dictionaryConfigId [int],
	@value [sql_variant]
)
RETURNS [nvarchar](MAX)
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_ExecuteHashSubstitution]
GO


CREATE FUNCTION [DataObfuscation].[fn_ExecuteHashShuffle]
(
	@dictionaryConfigId [int],
	@value [sql_variant]
)
RETURNS [nvarchar](MAX)
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_ExecuteHashShuffle]
GO


CREATE FUNCTION [DataObfuscation].[fn_ExecuteHashVariance]
(
	@dictionaryConfigId [int],
	@value [sql_variant]
)
RETURNS [sql_variant]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_ExecuteHashVariance]
GO


CREATE FUNCTION [DataObfuscation].[fn_ExecuteStrategy]
(
	@strategyId [int],
	@dictionaryConfigId [int],
	@value [sql_variant]
)
RETURNS [sql_variant]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_ExecuteStrategy]
GO


CREATE FUNCTION [DataObfuscation].[fn_GetObfuscatedTableViewColumnData]
(
	@catalogName as [nvarchar](64),
	@schemaName as [nvarchar](128),
	@tableName as [nvarchar](128),
	@columnName as [nvarchar](128),
	@value [sql_variant]
)
RETURNS [sql_variant]
AS EXTERNAL NAME [TextMetal.Common.SqlServerClr].[TextMetal.Common.SqlServerClr.ScalarFunctions].[fn_GetObfuscatedTableViewColumnData]
GO











-- TESTS
PRINT [DataObfuscation].[fn_GetHash](33, 1000, 5381, 'textmetal')
PRINT [DataObfuscation].[fn_GetHash](33, 1000, 5381, null)
PRINT [DataObfuscation].[fn_GetHash](33, 5, 5381, 'textmetal')

PRINT CAST([DataObfuscation].[fn_GetVariance](0.30, CAST('1/1/2014' AS [datetime])) AS NVARCHAR)
PRINT CAST([DataObfuscation].[fn_GetVariance](-0.30, CAST('1/1/2014' AS [datetime])) AS NVARCHAR)
PRINT CAST([DataObfuscation].[fn_GetVariance](-0.20, 25) AS NVARCHAR)
PRINT CAST([DataObfuscation].[fn_GetVariance](+0.5, 25.0) AS NVARCHAR)

PRINT [DataObfuscation].[fn_GetOneFouthMask]('5900123496001500')

-- DB SELECTS
PRINT [DataObfuscation].[fn_ExecuteHashSubstitution](-1000, 'textmetal')

PRINT CAST([DataObfuscation].[fn_ExecuteHashVariance](-1100, 25) AS NVARCHAR)
PRINT CAST([DataObfuscation].[fn_ExecuteHashVariance](-1100, 25.0) AS NVARCHAR)
PRINT CAST([DataObfuscation].[fn_ExecuteHashVariance](-1200, CAST('1/1/2014' AS [datetime])) AS NVARCHAR)

PRINT CAST([DataObfuscation].[fn_ExecuteHashShuffle](-1200, 'textmetal') AS NVARCHAR)

PRINT CAST([DataObfuscation].fn_ExecuteStrategy(0, -1000, 'textmetal') AS NVARCHAR)
PRINT CAST([DataObfuscation].fn_ExecuteStrategy(1, -1000, 'textmetal') AS NVARCHAR)
PRINT CAST([DataObfuscation].fn_ExecuteStrategy(2, -1000, 'textmetal') AS NVARCHAR)
PRINT CAST([DataObfuscation].fn_ExecuteStrategy(3, -1000, 1000) AS NVARCHAR)
PRINT CAST([DataObfuscation].fn_ExecuteStrategy(4, -1000, 'textmetal') AS NVARCHAR)
PRINT CAST([DataObfuscation].fn_ExecuteStrategy(5, -1000, 'textmetal') AS NVARCHAR)
PRINT CAST([DataObfuscation].fn_ExecuteStrategy(6, -1000, 'textmetal') AS NVARCHAR)

/*
153
-1
3
Pine Green
Jan 31 2014 12:00AM
Dec  2 2013 12:00AM
20
37.50
26
26.500
Apr  8 2014 12:00AM
************1500
*/
GO


]]>

	<ForEach in="Schemas" var-ct="_LoopCount" var-ix="_LoopIndex">
		<ForEach.Filter>
			<Ruby src="Script">
				<Script>!["db_accessadmin", "db_backupoperator", "db_datareader",
				"db_datawriter", "db_ddladmin", "db_denydatareader", "db_denydatawriter",
				"db_owner", "db_securityadmin", "dbo", "sys"].include?(textMetal.EvaluateToken.invoke("SchemaName"));</Script>
			</Ruby>	
		</ForEach.Filter>
		
		<ForEach.Body>
		
<![CDATA[

CREATE SCHEMA [${SchemaName}]
GO

]]>

			<ForEach in="Tables" var-ct="_LoopCount" var-ix="_LoopIndex">
				<ForEach.Filter>
				</ForEach.Filter>
				<ForEach.Body>
<![CDATA[

CREATE VIEW [${SchemaName}].[${TableName}]
AS

	SELECT
]]>
				<ForEach in="Columns" var-ct="_LoopCount" var-ix="_LoopIndex">
					<ForEach.Sort>
						<Ascending>
							<Ascending.Compare>
								<Facet name="ColumnOrdinal" />
							</Ascending.Compare>
						</Ascending>
					</ForEach.Sort>
					<ForEach.Body>
					
<![CDATA[${rb(`
	if ["varchar", "nvarchar"].include?(textMetal.EvaluateToken.invoke("ColumnSqlType"))
		"	CAST( [DataObfuscation].[fn_GetObfuscatedTableViewColumnData]('" +
		textMetal.EvaluateToken.invoke("InitialCatalogName") +
		"', '" +
		textMetal.EvaluateToken.invoke("SchemaName") +
		"', '" +
		textMetal.EvaluateToken.invoke("TableName") +
		"', '" +
		textMetal.EvaluateToken.invoke("ColumnName") +
		"', t.[" +
		textMetal.EvaluateToken.invoke("ColumnName") +
		"]) AS [" +
		textMetal.EvaluateToken.invoke("ColumnSqlType") +
		"](" +
		textMetal.EvaluateToken.invoke("ColumnSize").to_s() +
		") ) as [" +
		textMetal.EvaluateToken.invoke("ColumnName") +
		"]"
	else
		"	t.[" +	textMetal.EvaluateToken.invoke("ColumnName") + "]"
	end
`)}]]>

						<OutputScope name="ObfucationLayer.tvcfg.g.sql" append="true">
						<![CDATA[
INSERT INTO [DataObfuscation].[TableViewColumnConfig] VALUES ('${InitialCatalogName}', '${SchemaName}', '${TableName}', '${ColumnName}', 0, -1000);
						]]>
						</OutputScope>
					
						<If>
							<If.Condition>
								<BinaryExpression operator="Ne">
									<BinaryExpression.LeftExpression>
										<Facet name="_LoopCount" />
									</BinaryExpression.LeftExpression>
									<BinaryExpression.RightExpression>
										<Facet name="_LoopIndex" />
									</BinaryExpression.RightExpression>
								</BinaryExpression>
							</If.Condition>
							<If.True>
<![CDATA[,
]]>
							</If.True>
						</If>
					</ForEach.Body>
				</ForEach>
<![CDATA[
	FROM [${DataObfuscationTargetServerName}].[${InitialCatalogName}].[${SchemaName}].[${TableName}] t

GO
]]>
					
				</ForEach.Body>
			</ForEach>

		</ForEach.Body>
	</ForEach>
	
	
	</OutputScope>
</Template>